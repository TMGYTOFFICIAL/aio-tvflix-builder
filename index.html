<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIO.TVFLIX Builder v3.16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .page { display: none; }
        .page.active { display: block; }
        .step { display: none; }
        .step.active { display: block; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans min-h-screen p-2 md:p-8">

    <div class="fixed bottom-8 right-8 z-50 flex flex-col items-end gap-3 group">
        <div class="bg-slate-800 text-slate-200 text-xs font-bold py-2 px-4 rounded-xl border border-slate-600 shadow-2xl">
            Many hours went into this! ☕
        </div>
        
        <a href="https://buymeacoffee.com/particular_catch_449" target="_blank" class="flex items-center gap-3 bg-yellow-400 text-slate-900 px-6 py-4 rounded-full shadow-2xl hover:bg-yellow-300 hover:scale-105 transition-all font-bold text-base border-4 border-slate-900">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path d="M12.75 4.75a.75.75 0 00-1.5 0v.678c0 .285.03.567.088.843l.036.173a.75.75 0 001.464-.306l-.022-.108a4.773 4.773 0 01-.066-.602V4.75zM8.75 4.75a.75.75 0 00-1.5 0v.678c0 .285.03.567.088.843l.036.173a.75.75 0 001.464-.306l-.022-.108a4.773 4.773 0 01-.066-.602V4.75zM16.75 4.75a.75.75 0 00-1.5 0v.678c0 .285.03.567.088.843l.036.173a.75.75 0 001.464-.306l-.022-.108a4.773 4.773 0 01-.066-.602V4.75z" />
                <path fill-rule="evenodd" d="M3.5 9A1.5 1.5 0 005 10.5h14a1.5 1.5 0 001.5-1.5V8.5a.5.5 0 00-.5-.5H4a.5.5 0 00-.5.5v.5zm1.5 3a3 3 0 002.95 2.443l.79.098c.189.023.38.046.572.067a62.985 62.985 0 004.376 0c.192-.02.383-.044.572-.067l.79-.098A3 3 0 0020.5 12h-14zm14-4.5H22v1.5a3 3 0 01-3 3h-1.39a4.49 4.49 0 01-1.31 1.77 4.512 4.512 0 01-2.91.86c-1.42 0-2.812-.06-4.178-.18-1.332-.116-2.617-.375-3.842-.767a4.5 4.5 0 01-3.15-5.683H2V8.5a1 1 0 011-1h1.5z" clip-rule="evenodd" />
            </svg>
            <span>Leave a Tip (Optional)</span>
        </a>
    </div>

<div class="max-w-4xl mx-auto bg-slate-800 p-4 md:p-10 rounded-2xl shadow-2xl border border-slate-700 mb-32">        
        <div id="page-hub" class="page active">
            <header class="mb-10 text-center">
                <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 italic tracking-tighter mb-4">AIO.TVFLIX v2</h1>
                <p class="text-slate-400 text-lg">Personalized Master Template Builder</p>
                
                <div class="mt-8 max-w-2xl mx-auto bg-slate-900/50 p-6 rounded-xl border border-slate-700 text-left space-y-4">
                    <h3 class="text-white font-bold text-lg">What does this setup do for Stremio?</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-slate-400">
                        <div>
                            <strong class="text-indigo-400 block mb-1">Better Stream Sorting</strong>
                            <p>Intelligently sorts streams by language, quality, and resolution, prioritizing your specific choices.</p>
                        </div>
                        <div>
                            <strong class="text-indigo-400 block mb-1">Cleaner Catalogs</strong>
                            <p>Replaces cluttered lists with unified catalogs for streaming providers (Netflix, Disney+, etc.) directly from the source.</p>
                        </div>
                        <div>
                            <strong class="text-indigo-400 block mb-1">Optimized Metadata</strong>
                            <p>Provides consistent posters and ratings while removing duplicate entries to keep your library smooth and fast.</p>
                        </div>
                    </div>
                </div>
            </header>
            <div class="grid grid-cols-1 gap-6 mt-8">
                <button type="button" onclick="startSetup('full')" class="bg-slate-700 p-6 rounded-xl border border-indigo-500/30 hover:border-indigo-400 text-left transition-all hover:shadow-lg hover:shadow-indigo-500/10">
                    <h3 class="text-xl font-bold text-indigo-300">Full Setup</h3>
                    <p class="text-sm text-slate-400 mt-1">Generate both AIOStreams and Metadata files.</p>
                </button>
                <button type="button" onclick="startSetup('streams')" class="bg-slate-700 p-6 rounded-xl border border-slate-600 hover:border-indigo-400 text-left transition-all">
                    <h3 class="text-xl font-bold text-slate-200">AIOStreams Only</h3>
                    <p class="text-sm text-slate-400 mt-1">Configure scrapers, debrid, and languages.</p>
                </button>
                <button type="button" onclick="startSetup('meta')" class="bg-slate-700 p-6 rounded-xl border border-slate-600 hover:border-indigo-400 text-left transition-all">
                    <h3 class="text-xl font-bold text-slate-200">AIOMetadata Only</h3>
                    <p class="text-sm text-slate-400 mt-1">Configure catalogs, posters, and ratings.</p>
                </button>
                
                <a href="https://cinebye.elfhosted.com/" target="_blank" class="block bg-slate-800 p-4 rounded-xl border border-slate-600 hover:border-indigo-400 text-center transition-all mt-4 group">
                    <span class="text-slate-400 text-sm group-hover:text-white">Looking for <strong>CineBye</strong>? Click here to open the manager.</span>
                </a>
            </div>
        </div>

        <div id="page-wizard" class="page">
            <div id="setup-steps">
                
                <div class="step" id="step-debrid">
                    <h2 class="text-2xl font-bold mb-6 text-white tracking-tight">1. Debrid Integration</h2>
                    <p class="text-sm text-slate-400 mb-4">Select the debrid services you use. You can select multiple.</p>
                    <div id="debrid-list" class="space-y-4">
                        
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <div class="flex items-center justify-between mb-3">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" id="use-tb" class="debrid-check w-5 h-5 rounded border-slate-600 text-indigo-600 bg-slate-800" onchange="toggleDebridInput('tb-input', this.checked)">
                                    <span class="font-bold text-white">TorBox</span>
                                </label>
                                <a href="https://torbox.app/subscription?referral=1469bf2b-09fb-4c7e-a29f-6925fda84668" target="_blank" class="bg-indigo-600 text-[10px] font-bold px-3 py-1.5 rounded text-white hover:bg-indigo-500 uppercase tracking-wide">Sign Up</a>
                            </div>
                            <div id="tb-input" class="hidden pl-8">
                                <input type="text" id="key-torbox" placeholder="TorBox API Key" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                                <a href="https://torbox.app/settings" target="_blank" class="text-[10px] text-indigo-400 mt-1 block hover:underline">Get Key →</a>
                            </div>
                        </div>

                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <label class="flex items-center space-x-3 cursor-pointer mb-3">
                                <input type="checkbox" id="use-rd" class="debrid-check w-5 h-5 rounded border-slate-600 text-indigo-600 bg-slate-800" onchange="toggleDebridInput('rd-input', this.checked)">
                                <span class="font-bold text-white">Real-Debrid</span>
                            </label>
                            <div id="rd-input" class="hidden pl-8">
                                <input type="text" id="key-realdebrid" placeholder="Real-Debrid API Key" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                                <a href="https://real-debrid.com/apitoken" target="_blank" class="text-[10px] text-indigo-400 mt-1 block hover:underline">Get Key →</a>
                            </div>
                        </div>

                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <label class="flex items-center space-x-3 cursor-pointer mb-3">
                                <input type="checkbox" id="use-ad" class="debrid-check w-5 h-5 rounded border-slate-600 text-indigo-600 bg-slate-800" onchange="toggleDebridInput('ad-input', this.checked)">
                                <span class="font-bold text-white">AllDebrid</span>
                            </label>
                            <div id="ad-input" class="hidden pl-8">
                                <input type="text" id="key-alldebrid" placeholder="AllDebrid API Key" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                                <a href="https://alldebrid.com/apikeys/" target="_blank" class="text-[10px] text-indigo-400 mt-1 block hover:underline">Get Key →</a>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <label class="flex items-center space-x-3 cursor-pointer mb-3">
                                <input type="checkbox" id="use-pm" class="debrid-check w-5 h-5 rounded border-slate-600 text-indigo-600 bg-slate-800" onchange="toggleDebridInput('pm-input', this.checked)">
                                <span class="font-bold text-white">Premiumize</span>
                            </label>
                            <div id="pm-input" class="hidden pl-8">
                                <input type="text" id="key-premiumize" placeholder="Premiumize API Key" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                                <a href="https://www.premiumize.me/account" target="_blank" class="text-[10px] text-indigo-400 mt-1 block hover:underline">Get Key →</a>
                            </div>
                        </div>
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <label class="flex items-center space-x-3 cursor-pointer mb-3">
                                <input type="checkbox" id="use-dl" class="debrid-check w-5 h-5 rounded border-slate-600 text-indigo-600 bg-slate-800" onchange="toggleDebridInput('dl-input', this.checked)">
                                <span class="font-bold text-white">DebridLink</span>
                            </label>
                            <div id="dl-input" class="hidden pl-8">
                                <input type="text" id="key-debridlink" placeholder="DebridLink API Key" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                                <a href="https://debrid-link.com/webapp/apikey" target="_blank" class="text-[10px] text-indigo-400 mt-1 block hover:underline">Get Key →</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step" id="step-speed">
                    <h2 class="text-2xl font-bold mb-6 text-white tracking-tight">2. Performance Settings</h2>
                    <label class="flex items-center space-x-4 bg-slate-700/50 p-5 rounded-xl cursor-pointer mb-6 border border-transparent hover:border-indigo-500/50 transition-all">
                        <input type="checkbox" id="do-limit" class="w-6 h-6 rounded border-slate-600 text-indigo-600 bg-slate-800">
                        <p class="font-bold text-lg text-white">Limit file sizes based on speed?</p>
                    </label>
                    <div id="speed-options" class="hidden bg-slate-700/30 p-6 rounded-xl border border-slate-600 mb-6">
                        <label class="block mb-3 text-sm text-slate-400">Select speed bracket:</label>
                        <select id="speed-val" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white outline-none">
                            <option value="low">0-25 Mbps (Max 10GB Movies)</option>
                            <option value="mid">25-50 Mbps (Max 25GB Movies)</option>
                            <option value="high">50-100 Mbps (Max 50GB Movies)</option>
                            <option value="none">100+ Mbps (Unlimited)</option>
                        </select>
                    </div>
                    <div class="bg-slate-700/30 p-6 rounded-xl border border-slate-600">
                        <label class="block font-bold mb-3">Priority Preference</label>
                        <select id="sort-pref" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white outline-none">
                            <option value="quality">Quality First (Template Default)</option>
                            <option value="speed">Loading Speed First (Smallest Files)</option>
                        </select>
                    </div>
                </div>

                <div class="step" id="step-prefs">
                    <h2 class="text-2xl font-bold mb-4 text-white tracking-tight">3. Content Preferences</h2>
                    <div class="mb-6 bg-slate-700/30 p-6 rounded-xl border border-slate-600" id="section-interface-lang">
                        <label class="block font-bold mb-2">Interface Language (Metadata)</label>
                        <p class="text-xs text-slate-400 mb-3">Controls the language of titles and descriptions.</p>
                        <select id="interface-lang" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white outline-none">
                            <option value="en-US">English</option>
                            <option value="es-ES">Spanish</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="it-IT">Italian</option>
                            <option value="pt-PT">Portuguese</option>
                            <option value="ru-RU">Russian</option>
                            <option value="hi-IN">Hindi</option>
                            <option value="ja-JP">Japanese</option>
                            <option value="ko-KR">Korean</option>
                            <option value="zh-CN">Chinese</option>
                            <option value="ar-SA">Arabic</option>
                        </select>
                    </div>
                    
                    <div class="mb-6 bg-slate-700/30 p-6 rounded-xl border border-slate-600" id="section-autoplay">
                        <label class="block font-bold mb-2">AutoPlay Method (Streams)</label>
                        <p class="text-xs text-slate-400 mb-3">Decides how the next episode matches.</p>
                        <select id="autoplay-method" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg text-white outline-none">
                            <option value="matchingFile">Matching File (Best for Season Packs)</option>
                            <option value="matchingIndex">Matching Index (Fallback for weird packs)</option>
                            <option value="firstFile">First File (Simplest)</option>
                        </select>
                    </div>

                    <div class="mb-8" id="section-languages">
                        <div class="bg-slate-700/30 p-6 rounded-xl border border-slate-600">
                            <label class="block font-bold mb-2">Audio Languages (Streams)</label>
                            <p class="text-xs text-slate-400 mb-4">Select languages for streaming sources. Used to sort and filter streams. Selecting a foreign language here removes English from priority.</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="lang-grid"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div id="prefs-res-limit" class="bg-slate-700/30 p-6 rounded-xl border border-slate-600">
                            <label class="block font-bold mb-2">Max Results per Resolution</label>
                            <p class="text-xs text-slate-400 mb-3">Changes strictness of group fetching.</p>
                            <input type="number" id="res-limit" value="5" min="1" max="20" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white outline-none focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div id="cam-box" class="bg-slate-700/30 p-6 rounded-xl border border-slate-600 flex items-center">
                            <label class="flex items-center space-x-4 cursor-pointer w-full">
                                <input type="checkbox" id="include-cams" class="w-6 h-6 rounded border-slate-600 text-indigo-600 bg-slate-800">
                                <div>
                                    <p class="font-bold text-white">Include CAMs?</p>
                                    <p class="text-xs text-slate-400">Low quality screeners.</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="step" id="step-catalogs">
                    <h2 class="text-2xl font-bold mb-4 text-white tracking-tight">4. Catalog Manager</h2>
                    <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                            <h3 class="text-lg font-bold text-indigo-300">Catalog Order & Visibility</h3>
                            <div class="flex gap-2">
                                <button type="button" onclick="moveStreamingToTop()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold transition-all">Prioritize Streaming Services</button>
                                <label class="flex items-center space-x-2 cursor-pointer bg-slate-800 px-3 py-1 rounded-lg border border-slate-600">
                                    <input type="checkbox" id="include-anime" checked class="w-4 h-4 text-indigo-600 rounded" onchange="renderCatalogs()">
                                    <span class="text-xs font-bold uppercase tracking-wider">Include Anime</span>
                                </label>
                            </div>
                        </div>
                        <p class="text-xs text-slate-400 mb-4">Reorder using Up/Down. Toggle <span class="text-white">Home</span> (Dashboard) or <span class="text-white">Discovery</span> (Enabled) for each provider.</p>
                        
                        <div class="bg-slate-800/80 p-3 rounded-t border-b border-slate-700 flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-400 uppercase">Global Controls</span>
                            <div class="flex gap-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="select-all-home" onchange="toggleAllCatalogs('home', this.checked)" class="rounded bg-slate-700 border-slate-600 text-indigo-500 w-4 h-4">
                                    <span class="text-xs text-slate-300 font-bold">All Home</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="select-all-discovery" onchange="toggleAllCatalogs('discovery', this.checked)" class="rounded bg-slate-700 border-slate-600 text-indigo-500 w-4 h-4">
                                    <span class="text-xs text-slate-300 font-bold">All Disc.</span>
                                </label>
                            </div>
                        </div>

                        <div class="max-h-[500px] overflow-y-auto pr-2 space-y-2 custom-scroll" id="catalog-container">
                            </div>
                    </div>
                </div>

                <div class="step" id="step-keys">
                    <h2 class="text-2xl font-bold mb-6 text-white tracking-tight">5. API Credentials</h2>
                    
                    <div id="debridio-section" class="mb-6">
                        <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-xl mb-4">
                            <label class="flex items-center space-x-4 cursor-pointer">
                                <input type="checkbox" id="enable-debridio" class="w-6 h-6 rounded border-slate-600 text-indigo-600 bg-slate-800" onchange="toggleDebridio(this.checked)">
                                <div>
                                    <p class="font-bold text-white">Enable Debridio Scraper?</p>
                                    <p class="text-xs text-indigo-300">Requires a Debridio API Key.</p>
                                </div>
                            </label>
                        </div>
                        <div id="debridio-input" class="hidden pl-4">
                            <input type="text" id="debridio-key" placeholder="Paste Debridio API Key" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg text-white outline-none focus:ring-1 focus:ring-indigo-500">
                            <a href="https://debridio.com/account" target="_blank" class="text-[10px] text-indigo-400 mt-2 block hover:underline">Get Debridio Key →</a>
                        </div>
                    </div>

                    <div class="bg-slate-900/80 p-5 rounded-xl border border-indigo-500/20 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <p class="text-xs text-indigo-400 font-bold uppercase tracking-widest">TMDb Config <span class="text-red-500">*</span></p>
                            <input type="text" id="tmdb-key" placeholder="API Key (v3)" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                            <a href="https://www.themoviedb.org/settings/api" target="_blank" class="text-[10px] text-slate-500 hover:text-indigo-400 block underline">TMDb API Settings</a>
                            <div id="streams-token-field">
                                <textarea id="tmdb-token" rows="3" placeholder="Read Access Token (v4)" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-xs text-white outline-none mt-2"></textarea>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <p class="text-xs text-indigo-400 font-bold uppercase tracking-widest">Additional Providers</p>
                            <div id="tvdb-field">
                                <input type="text" id="tvdb-key" placeholder="TVDB API Key" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                                <a href="https://thetvdb.com/dashboard/account/apikey" target="_blank" class="text-[10px] text-slate-500 hover:text-indigo-400 block underline mt-1">TVDB API Settings</a>
                            </div>
                            <div id="fanart-field" class="mt-2">
                                <input type="text" id="fanart-key" placeholder="Fanart API Key" class="w-full bg-slate-800 border border-slate-700 p-2 rounded text-sm text-white outline-none">
                                <a href="https://fanart.tv/get-an-api-key/" target="_blank" class="text-[10px] text-slate-500 hover:text-indigo-400 block underline mt-1">Fanart API Settings</a>
                            </div>
                        </div>
                    </div>

                    <div id="gemini-section" class="mt-6">
                        <div class="bg-amber-900/20 border border-amber-600/30 p-4 rounded-xl mb-4">
                            <label class="flex items-center space-x-4 cursor-pointer">
                                <input type="checkbox" id="enable-gemini" class="w-6 h-6 rounded border-slate-600 text-indigo-600 bg-slate-800" onchange="toggleGemini(this.checked)">
                                <div>
                                    <p class="font-bold text-white">Enable Gemini AI Search? (Optional)</p>
                                    <p class="text-xs text-amber-400">Note: This is a paid service from Google.</p>
                                </div>
                            </label>
                        </div>
                        <div id="gemini-input" class="hidden pl-4">
                            <input type="text" id="gemini-key" placeholder="Paste Gemini API Key" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-lg text-white outline-none">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-indigo-400 mt-1 block hover:underline">Get Gemini API Key →</a>
                        </div>
                    </div>
                </div>

                <div class="step" id="step-posters">
                    <h2 class="text-2xl font-bold mb-6 text-white tracking-tight">6. Poster Ratings</h2>
                    <label class="flex items-center space-x-4 bg-slate-700/50 p-5 rounded-xl cursor-pointer mb-6 border border-transparent hover:border-indigo-500/50 transition-all">
                        <input type="checkbox" id="do-posters" class="w-6 h-6 rounded border-slate-600 text-indigo-600 bg-slate-800">
                        <p class="font-bold text-lg leading-tight text-white">Enable rated posters? (Free & Paid Options)</p>
                    </label>
                    <div id="poster-options" class="hidden space-y-4">
                        <select id="poster-provider" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-xl text-white outline-none">
                            <option value="top">TOP Posters API (Free Tier Available)</option>
                            <option value="rpdb">RPDB (RatingPosterDB)</option>
                        </select>
                        <input type="text" id="poster-key" placeholder="Paste API Key (Required if enabled)" class="w-full bg-slate-900 border border-indigo-500/50 p-4 rounded-xl text-white outline-none">
                        <div class="flex space-x-6 text-[10px] text-indigo-400 uppercase font-bold tracking-widest underline">
                            <a href="https://api.top-streaming.stream/" target="_blank">TOP Link</a>
                            <a href="https://ratingposterdb.com/" target="_blank">RPDB Link</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-12 flex justify-between pt-6 border-t border-slate-700">
                <button type="button" id="prev-btn" onclick="goBack()" class="bg-slate-700 px-8 py-3 rounded-xl font-bold hover:bg-slate-600 transition-all border border-slate-600">Back</button>
                <button type="button" id="next-btn" onclick="validateAndGoNext()" class="bg-indigo-600 px-10 py-3 rounded-xl font-bold hover:bg-indigo-500 transition-all shadow-lg ml-auto">Next Step</button>
                <button type="button" id="finish-btn" class="hidden bg-green-600 px-10 py-3 rounded-xl font-bold hover:bg-green-500 transition-all shadow-lg ml-auto" onclick="validateAndFinalize()">Generate Files</button>
            </div>
        </div>

        <div id="page-downloads" class="page text-center">
            <h2 class="text-3xl font-bold mb-4 text-indigo-400 tracking-tighter italic">BUILD COMPLETE</h2>
            <p class="text-slate-400 mb-6">Download your config files below.</p>
            
            <div id="dl-container" class="flex flex-col gap-4 max-w-sm mx-auto mb-10"></div>
            
            <div id="instructions-area" class="text-left max-w-2xl mx-auto space-y-8 hidden">
                
                <div class="space-y-6">
                    <div id="instr-meta" class="bg-slate-800 p-5 rounded-xl border border-indigo-500/30 hidden">
                        <h3 class="text-lg font-bold text-indigo-300 mb-2">1. Install AIO Metadata</h3>
                        <p class="text-sm text-slate-400 mb-3">Go to <a href="https://aiometadatafortheweak.nhyira.dev/configure/" target="_blank" class="text-indigo-400 underline">AIO Metadata Config</a></p>
                        <div class="text-slate-300 text-xs space-y-2">
                            <p><strong>To Import:</strong> Go to the <strong>Configuration</strong> tab and click <strong>Import</strong> to load your <code>aiometadata-config.json</code> file.</p>
                            <p><strong>To get the URL:</strong> On the same <strong>Configuration</strong> tab, click Save, create a password. The URL will appear under the save button.</p>
                            <div class="bg-slate-700/50 p-2 rounded border-l-4 border-green-500">
                                <strong class="text-green-400">INSTALL:</strong> Click the <strong>Install</strong> button next to the URL to open Stremio directly.
                            </div>
                        </div>
                        <div class="mt-4 bg-amber-900/20 border border-amber-600/30 p-4 rounded-lg text-xs text-amber-200 leading-relaxed">
                            <strong class="block mb-1 text-amber-400 uppercase tracking-wide">! IMPORTANT !</strong> 
                            Keep your AIO Key safe! Store it like a password. This is a live environment, meaning you can edit these settings in the future on the website and the updates will pull across to Stremio automatically. You won't ever have to reinstall the addon in Stremio again to update your settings.
                        </div>
                    </div>

                    <div id="instr-streams" class="bg-slate-800 p-5 rounded-xl border border-indigo-500/30 hidden">
                        <h3 class="text-lg font-bold text-emerald-300 mb-2">2. Install AIO Streams</h3>
                        <p class="text-sm text-slate-400 mb-3">Go to <a href="https://aiostreamsfortheweak.nhyira.dev/stremio/configure?menu=save-install" target="_blank" class="text-emerald-400 underline">AIO Streams Config</a></p>
                        <div class="text-slate-300 text-xs space-y-2">
                            <p>Click the <strong>Save & Install</strong> tab.</p>
                            <p><strong>To Import:</strong> Click <strong>Import</strong> then <strong>Import Config</strong> to load your <code>aiostreams-config.json</code> file.</p>
                            <p><strong>To get the URL:</strong> Click Save, create a password.</p>
                            <div class="bg-slate-700/50 p-2 rounded border-l-4 border-green-500">
                                <strong class="text-green-400">INSTALL:</strong> Click the <strong>Install</strong> button to open Stremio directly.
                            </div>
                            <p class="text-[10px] text-slate-500 italic">(Only copy the URL if the button doesn't work).</p>
                        </div>
                        <div class="bg-slate-900/50 p-2 rounded text-[10px] text-amber-400 border border-amber-500/20 my-2">
                            <strong>Note:</strong> If streams don't load, try the <a href="https://aiostreamsfortheweebs.midnightignite.me/stremio/configure" target="_blank" class="underline text-amber-200">Alternative Link</a>.
                        </div>
                        <div class="mt-4 bg-amber-900/20 border border-amber-600/30 p-4 rounded-lg text-xs text-amber-200 leading-relaxed">
                            <strong class="block mb-1 text-amber-400 uppercase tracking-wide">! IMPORTANT !</strong> 
                            Keep your AIO Key safe! Store it like a password. This is a live environment, meaning you can edit these settings in the future on the website and the updates will pull across to Stremio automatically. You won't ever have to reinstall the addon in Stremio again to update your settings.
                        </div>
                    </div>
                </div>

                <div id="instr-final" class="bg-slate-800 p-6 rounded-xl border border-slate-600">
                    </div>
            </div>

            <div class="mt-12 flex justify-center gap-4">
                <button onclick="goBackToWizard()" class="text-slate-400 hover:text-white uppercase text-xs font-bold tracking-widest transition-all px-6 py-3 border border-slate-600 rounded-lg">Back to Editor</button>
                <button onclick="location.reload()" class="text-slate-400 hover:text-white uppercase text-xs font-bold tracking-widest transition-all px-6 py-3 border border-slate-600 rounded-lg">Start New Setup</button>
            </div>
        </div>
    </div>

    <script>
        // --- EMBEDDED JSON DATA START (Sanitized & Pruned) ---
        const MASTER_METADATA = {
            "version": "1.23.5",
            "config": {
                "language": "en-GB",
                "includeAdult": false,
                "blurThumbs": false,
                "showPrefix": false,
                "showMetaProviderAttribution": false,
                "castCount": 10,
                "displayAgeRating": true,
                "showDisabledCatalogs": false,
                "sfw": true,
                "hideUnreleasedDigital": true,
                "providers": { "movie": "tmdb", "series": "tvdb", "anime": "tvdb", "anime_id_provider": "kitsu", "forceAnimeForDetectedImdb": true },
                "artProviders": { "movie": { "poster": "imdb", "background": "imdb", "logo": "imdb" }, "series": { "poster": "tvdb", "background": "tvdb", "logo": "tvdb" }, "anime": { "poster": "fanart", "background": "fanart", "logo": "fanart" }, "englishArtOnly": true },
                "tvdbSeasonType": "default",
                "mal": { "skipFiller": false, "skipRecap": false, "allowEpisodeMarking": false, "useImdbIdForCatalogAndSearch": true },
                "tmdb": { "scrapeImdb": true, "forceLatinCastNames": false },
                "apiKeys": { "gemini": "", "tmdb": "", "tvdb": "", "fanart": "", "rpdb": "", "topPoster": "", "mdblist": "", "trakt": "", "addonVersion": "1.14.2", "hasBuiltInTvdb": false, "hasBuiltInTmdb": false, "catalogTTL": 86400 },
                "posterRatingProvider": "top",
                "mdblistWatchTracking": false,
                "anilistWatchTracking": false,
                "enableRatingPostersForLibrary": true,
                "ageRating": "None",
                "searchEnabled": true,
                "timezone": "Europe/London",
                "catalogs": [
					{ "id": "tmdb.now_playing", "name": "Latest Releases", "type": "movie", "source": "tmdb", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "movie" },
					{ "id": "tmdb.airing_today", "name": "Latest Releases", "type": "series", "source": "tmdb", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "series" }, 
                    
                    { "id": "tmdb.top_rated", "name": "Genres", "type": "movie", "source": "tmdb", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "movie" },
                    { "id": "tmdb.top_rated", "name": "Genres", "type": "series", "source": "tmdb", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "series" },

                    { "id": "tmdb.top", "name": "Popular", "type": "movie", "source": "tmdb", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "movie" },
                    { "id": "tmdb.top", "name": "Popular", "type": "series", "source": "tmdb", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "series" },
                    
                    { "id": "tmdb.year", "name": "By Year", "type": "movie", "source": "tmdb", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "movie" },
                    { "id": "tmdb.year", "name": "By Year", "type": "series", "source": "tmdb", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "series" },
                    
                    { "id": "tmdb.trending", "name": "Trending", "type": "movie", "source": "tmdb", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "movie" },
                    { "id": "tmdb.trending", "name": "Trending", "type": "series", "source": "tmdb", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "series" },
                    { "id": "streaming.nfx", "name": "Netflix (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.nfx", "name": "Netflix (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "mal.most_popular", "name": "Most Popular", "type": "anime", "source": "mal", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "streaming.dnp", "name": "Disney+ (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.dnp", "name": "Disney+ (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.amp", "name": "Prime Video (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.amp", "name": "Prime Video (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "mal.airing", "name": "Airing Now", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "streaming.hbm", "name": "HBO Max (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hbm", "name": "HBO Max (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.atp", "name": "Apple TV+ (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.atp", "name": "Apple TV+ (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "mal.top_anime", "name": "Top Anime", "type": "anime", "source": "mal", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "streaming.hlu", "name": "Hulu (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hlu", "name": "Hulu (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.pcp", "name": "Peacock Premium (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.pcp", "name": "Peacock Premium (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "mal.top_movies", "name": "Top Movies", "type": "anime", "source": "mal", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.top_series", "name": "Top Series", "type": "anime", "source": "mal", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.upcoming", "name": "Upcoming Season", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.schedule", "name": "Airing Schedule", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.seasons", "name": "Seasons", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.80sDecade", "name": "Best of 80s", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.90sDecade", "name": "Best of 90s", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.00sDecade", "name": "Best of 2000s", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.10sDecade", "name": "Best of 2010s", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.20sDecade", "name": "Best of 2020s", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.genres", "name": "Genres", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.studios", "name": "By Studio", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "mal.most_favorites", "name": "Most Favorites", "type": "anime", "source": "mal", "enabled": true, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false, "displayType": "anime" },
                    { "id": "streaming.nfk", "name": "Netflix Kids (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.nfk", "name": "Netflix Kids (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.pmp", "name": "Paramount+ (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.pmp", "name": "Paramount+ (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.cts", "name": "Curiosity Stream (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.cts", "name": "Curiosity Stream (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.mgl", "name": "MagellanTV (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.mgl", "name": "MagellanTV (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.cru", "name": "Crunchyroll (Movies)", "type": "movie", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.cru", "name": "Crunchyroll (Series)", "type": "series", "source": "streaming", "enabled": true, "showInHome": true, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hay", "name": "Hayu (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hay", "name": "Hayu (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.clv", "name": "Clarovideo (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.clv", "name": "Clarovideo (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.gop", "name": "Globoplay (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.gop", "name": "Globoplay (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hst", "name": "JioHotstar (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hst", "name": "JioHotstar (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.slv", "name": "Sony Liv (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.slv", "name": "Sony Liv (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.zee", "name": "Zee5 (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.zee", "name": "Zee5 (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.nlz", "name": "NLZIET (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.nlz", "name": "NLZIET (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.vil", "name": "Videoland (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.vil", "name": "Videoland (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.sst", "name": "SkyShowtime (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.sst", "name": "SkyShowtime (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.sky", "name": "Sky Go (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.sky", "name": "Sky Go (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.wow", "name": "WOW (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.wow", "name": "WOW (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.blv", "name": "BluTV (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.blv", "name": "BluTV (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.cpd", "name": "Canal+ (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.cpd", "name": "Canal+ (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.crv", "name": "Crave (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.crv", "name": "Crave (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.dpe", "name": "Discovery+ (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.dpe", "name": "Discovery+ (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.bet", "name": "Bet+ (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.bet", "name": "Bet+ (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.mub", "name": "MUBI (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.mub", "name": "MUBI (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.sta", "name": "Starz (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.sta", "name": "Starz (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.crc", "name": "Criterion Channel (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.crc", "name": "Criterion Channel (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hid", "name": "HIDIVE (Movies)", "type": "movie", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false },
                    { "id": "streaming.hid", "name": "HIDIVE (Series)", "type": "series", "source": "streaming", "enabled": false, "showInHome": false, "enableRatingPosters": true, "randomizePerPage": false }
                ],
                "search": {
                    "enabled": true,
                    "ai_enabled": true,
                    "providers": { "movie": "tmdb.search", "series": "tvdb.search", "anime_movie": "kitsu.search.movie", "anime_series": "kitsu.search.series" },
                    "engineEnabled": { "tmdb.search": true, "tvdb.search": true, "tvdb.collections.search": true, "tvmaze.search": true, "mal.search.movie": true, "mal.search.series": true, "gemini.search": true },
                    "providerNames": { "tmdb.search": ".", "tvdb.search": ".", "mal.search.series": ".", "mal.search.movie": "." },
                    "searchOrder": [ "movie", "series", "tvdb.collections.search", "anime_series", "anime_movie" ],
                    "engineRatingPosters": { "gemini.search": true },
                    "searchNames": { "tvdb.collections.search": "Collections" }
                },
                "streaming": [ "nfx", "nfk", "hbm", "dnp", "amp", "atp", "pmp", "pcp", "hlu", "mgl", "cru", "dpe", "bet", "mub", "sta", "crc", "sky", "wow", "sst", "hay" ],
                "displayTypeOverrides": {}
            },
            "metadata": {
                "apiKeysExcluded": true,
                "totalCatalogs": 57,
                "enabledCatalogs": 51
            }
        };

const MASTER_WITHOUT_DEBRID = {
            "services": [
                { "id": "realdebrid", "enabled": false, "credentials": {} }, { "id": "alldebrid", "enabled": false, "credentials": {} }, { "id": "premiumize", "enabled": false, "credentials": {} },
                { "id": "debridlink", "enabled": false, "credentials": {} }, { "id": "torbox", "enabled": false, "credentials": {} }, { "id": "offcloud", "enabled": false, "credentials": {} },
                { "id": "putio", "enabled": false, "credentials": {} }, { "id": "easynews", "enabled": false, "credentials": {} }, { "id": "easydebrid", "enabled": false, "credentials": {} },
                { "id": "debrider", "enabled": false, "credentials": {} }, { "id": "pikpak", "enabled": false, "credentials": {} }, { "id": "seedr", "enabled": false, "credentials": {} },
                { "id": "stremio_nntp", "enabled": false, "credentials": {} }, { "id": "nzbdav", "enabled": false, "credentials": {} }, { "id": "altmount", "enabled": false, "credentials": {} }
            ],
            "presets": [
                { "type": "mediafusion", "instanceId": "bcd", "enabled": true, "options": { "name": "MediaFusion", "timeout": 10000, "resources": ["stream", "catalog", "meta"], "useCachedResultsOnly": false, "enableWatchlistCatalogs": false, "downloadViaBrowser": false, "contributorStreams": false, "certificationLevelsFilter": [], "nudityFilter": [], "mediaTypes": [] } },
                { "type": "comet", "instanceId": "1c5", "enabled": true, "options": { "name": "Comet", "timeout": 10000, "resources": ["stream"], "includeP2P": true, "removeTrash": true, "mediaTypes": [] } },
                { "type": "torrentio", "instanceId": "23a", "enabled": true, "options": { "name": "Torrentio", "timeout": 10000, "resources": ["stream", "catalog", "meta"], "useMultipleInstances": false, "providers": [] } }
            ],
            "formatter": {
                "id": "custom",
                "definition": {
                    "name": "{stream.resolution::exists[\"{stream.resolution::replace('2160p','4K')::replace('1080p','HD')::replace('720p','SD')}\"||\"\"]} {stream.quality::exists[\"{stream.quality::replace('REMUX','+')::replace('BluRay','⭐⭐⭐⭐⭐')::replace('WEB-DL','⭐⭐⭐⭐')::replace('WEBRip','⭐⭐⭐⭐')}\"||\"\"]}\n",
                    "description": "{stream.title::exists[\"🎬 {stream.title}\"||\"\"]}{stream.seasonEpisode::exists[\" - {stream.seasonEpisode::join(' ')}\"||\"\"]}{stream.year::exists[\" ({stream.year})\"||\"\"]}\n───────────────────\n{stream.languageEmojis::exists[\"Languages: {stream.languageEmojis}\"||\"\"]}\n{stream.quality::exists[\"✨ {stream.quality::replace('REMUX','+')::replace('BluRay','Premium Quality')::replace('WEB-DL','Streaming Quality')::replace('WEBRip','Streaming Quality')}\"||\"\"]}{stream.visualTags::~HDR::istrue[\" | 🌈 HDR\"||\"\"]}{stream.visualTags::~DV::istrue[\" | 🎥 Dolby Vision\"||\"\"]}{stream.audioTags::exists[\" | 🔊 {stream.audioTags::join(', ')}\"||\"\"]}\n───────────────────\n📂 {stream.size::>0[\"{stream.size::bytes}\"||\"\"]}{stream.seeders::>0[\" | 👥 {stream.seeders}\"||\"\"]}{addon.name::exists[\" | 🛰️ {addon.name}\"||\"\"]}"
                }
            },
            "preferredQualities": ["BluRay REMUX", "BluRay", "WEB-DL", "WEBRip", "HDRip", "HC HD-Rip", "DVDRip", "HDTV", "CAM", "TS", "TC", "SCR", "Unknown"],
            "preferredResolutions": ["2160p", "1440p", "1080p", "720p"],
            "excludedQualities": ["CAM", "SCR", "TS", "TC"],
            "excludedVisualTags": ["3D"],
            "sortCriteria": {
                "global": [
                    { "key": "seeders", "direction": "desc" }, { "key": "resolution", "direction": "desc" }, { "key": "size", "direction": "desc" }
                ],
                "uncached": [
                    { "key": "seeders", "direction": "desc" }, { "key": "resolution", "direction": "desc" }, { "key": "size", "direction": "desc" }
                ]
            },
            "posterService": "rpdb",
            "deduplicator": { "enabled": true, "excludeAddons": [], "multiGroupBehaviour": "aggressive", "keys": ["filename", "infoHash"], "cached": "per_addon", "uncached": "per_service", "p2p": "single_result" },
            "trusted": false,
            "excludedResolutions": ["144p", "240p", "360p", "480p", "576p"],
            "includedResolutions": [],
            "requiredResolutions": [],
            "includedQualities": [],
            "requiredQualities": [],
            "excludedLanguages": [],
            "includedLanguages": [],
            "requiredLanguages": [],
            "preferredLanguages": ["English"],
            "includedVisualTags": [],
            "requiredVisualTags": [],
            "preferredVisualTags": ["HDR+DV", "DV Only", "HDR Only", "HDR10+", "HDR10", "DV", "HDR"],
            "excludedAudioTags": [],
            "includedAudioTags": [],
            "requiredAudioTags": [],
            "preferredAudioTags": ["Atmos", "DD+", "DD", "DTS-HD MA", "DTS-HD", "DTS-ES", "DTS", "TrueHD", "OPUS", "FLAC", "AAC"],
            "excludedAudioChannels": [],
            "includedAudioChannels": [],
            "requiredAudioChannels": [],
            "preferredAudioChannels": [],
            "excludedStreamTypes": [],
            "includedStreamTypes": [],
            "requiredStreamTypes": [],
            "preferredStreamTypes": ["p2p"],
            "excludedEncodes": [],
            "includedEncodes": [],
            "requiredEncodes": [],
            "preferredEncodes": [],
            "excludedKeywords": [],
            "includeSeederRange": [10, 100000],
            "requiredSeederRange": [10, 100000],
            "seederRangeTypes": ["p2p"],
            "ageRangeTypes": ["usenet"],
            "digitalReleaseFilter": { "enabled": false, "tolerance": 1, "requestTypes": ["movie", "series", "anime"], "addons": [] },
            "excludeCachedFromAddons": [],
            "excludeCachedFromServices": [],
            "excludeCachedFromStreamTypes": [],
            "excludeUncached": false,
            "excludeUncachedFromAddons": [],
            "excludeUncachedFromServices": [],
            "excludeUncachedFromStreamTypes": [],
            "dynamicAddonFetching": { "enabled": false, "condition": "count(totalStreams) >= 15 or totalTimeTaken >= 10000" },
            "groups": {
                "enabled": true,
                "groupings": [
                    { "addons": ["23a", "1c5", "bcd", "e7b"], "condition": "true" }
                ],
                "behaviour": "parallel"
            },
            "proxy": { "id": "builtin", "proxiedAddons": [], "proxiedServices": [] },
            "resultLimits": { "resolution": 5 },
            "size": { "global": { "movies": [0, 100000000000], "series": [0, 100000000000] } },
            "hideErrors": true,
            "hideErrorsForResources": [],
            "statistics": { "statsToShow": ["addon", "filter"] },
            "yearMatching": { "enabled": true, "requestTypes": [], "addons": [] },
            "titleMatching": { "mode": "contains", "enabled": true, "requestTypes": [], "addons": [] },
            "seasonEpisodeMatching": { "enabled": true, "requestTypes": [], "addons": [] },
            "autoPlay": { "attributes": ["service"] },
            "areYouStillThere": { "enabled": true, "episodesBeforeCheck": 4 },
            "precacheNextEpisode": false,
            "alwaysPrecache": false,
            "catalogModifications": [],
            "cacheAndPlay": { "streamTypes": [] },
            "autoRemoveDownloads": true
        };

        const MASTER_WITH_DEBRID = {
            "services": [
                { "id": "realdebrid", "enabled": false, "credentials": {} }, { "id": "alldebrid", "enabled": false, "credentials": {} }, { "id": "premiumize", "enabled": false, "credentials": {} },
                { "id": "debridlink", "enabled": false, "credentials": {} }, { "id": "torbox", "enabled": true, "credentials": {} }, { "id": "offcloud", "enabled": false, "credentials": {} },
                { "id": "putio", "enabled": false, "credentials": {} }, { "id": "easynews", "enabled": false, "credentials": {} }, { "id": "easydebrid", "enabled": false, "credentials": {} },
                { "id": "debrider", "enabled": false, "credentials": {} }, { "id": "pikpak", "enabled": false, "credentials": {} }, { "id": "seedr", "enabled": false, "credentials": {} },
                { "id": "stremio_nntp", "enabled": false, "credentials": {} }, { "id": "nzbdav", "enabled": false, "credentials": {} }, { "id": "altmount", "enabled": false, "credentials": {} }
            ],
            "presets": [
                { "type": "mediafusion", "instanceId": "bcd", "enabled": true, "options": { "name": "MediaFusion", "timeout": 10000, "resources": ["stream", "catalog", "meta"], "useCachedResultsOnly": false, "enableWatchlistCatalogs": false, "downloadViaBrowser": false, "contributorStreams": false, "certificationLevelsFilter": [], "nudityFilter": [], "mediaTypes": [] } },
                { "type": "comet", "instanceId": "1c5", "enabled": true, "options": { "name": "Comet", "timeout": 10000, "resources": ["stream"], "includeP2P": false, "removeTrash": true, "mediaTypes": [] } },
                { "type": "stremthruTorz", "instanceId": "be5", "enabled": true, "options": { "name": "StremThru Torz", "timeout": 10000, "resources": ["stream"], "mediaTypes": [], "includeP2P": false, "useMultipleInstances": false } },
                { "type": "torrentio", "instanceId": "23a", "enabled": true, "options": { "name": "Torrentio", "timeout": 10000, "resources": ["stream", "catalog", "meta"], "useMultipleInstances": false, "providers": [] } },
                { "type": "jackettio", "instanceId": "da0", "enabled": true, "options": { "name": "Jackettio", "timeout": 10000, "resources": ["stream"], "mediaTypes": [] } },
                { "type": "torrent-galaxy", "instanceId": "92e", "enabled": true, "options": { "name": "TorrentGalaxy", "timeout": 10000, "mediaTypes": [], "useMultipleInstances": false } },
                { "type": "knaben", "instanceId": "705", "enabled": true, "options": { "name": "Knaben", "timeout": 10000, "mediaTypes": [], "useMultipleInstances": false } },
                { "type": "bitmagnet", "instanceId": "9a3", "enabled": true, "options": { "name": "Bitmagnet", "timeout": 10000, "mediaTypes": [], "useMultipleInstances": false, "paginate": false } },
                { "type": "animetosho", "instanceId": "f89", "enabled": true, "options": { "name": "AnimeTosho", "timeout": 10000, "mediaTypes": [], "useMultipleInstances": false } },
                { "type": "seadex", "instanceId": "a9a", "enabled": true, "options": { "name": "SeaDex", "timeout": 10000, "mediaTypes": ["anime"] } }
            ],
            "formatter": {
                "id": "custom",
                "definition": {
                    "name": "{stream.resolution::exists[\"{stream.resolution::replace('2160p','4K')::replace('1080p','HD')::replace('720p','SD')}\"||\"\"]} {stream.quality::exists[\"{stream.quality::replace('REMUX','+')::replace('BluRay','⭐⭐⭐⭐⭐')::replace('WEB-DL','⭐⭐⭐⭐')::replace('WEBRip','⭐⭐⭐⭐')}\"||\"\"]} {service.cached::istrue[\"⚡\"||\"⏳\"]}",
                    "description": "{stream.type::=usenet[\"📦 USN \"||\"\"]}{stream.title::exists[\"🎬 {stream.title}\"||\"\"]}{stream.seasonEpisode::exists[\" - {stream.seasonEpisode::join(' ')}\"||\"\"]}{stream.year::exists[\" ({stream.year})\"||\"\"]}\n{service.cached::istrue[\"🟢 INSTANT PLAY\"||\"🔴 NEEDS TO DOWNLOAD\"]}\n─────────────\n{stream.languageEmojis::exists[\"Languages: {stream.languageEmojis}\"||\"\"]}\n{stream.quality::exists[\"✨ {stream.quality::replace('REMUX','+')::replace('BluRay','Premium Quality')::replace('WEB-DL','Streaming Quality')::replace('WEBRip','Streaming Quality')}\"||\"\"]}{stream.visualTags::~HDR::istrue[\" | 🌈 HDR\"||\"\"]}{stream.visualTags::~DV::istrue[\" | 🎥 Dolby Vision\"||\"\"]}{stream.audioTags::exists[\" | 🔊 {stream.audioTags::join(', ')}\"||\"\"]}\n─────────────\n📂 {stream.size::>0[\"{stream.size::bytes}\"||\"\"]}{service.name::exists[\" | ☁️ {service.name}\"||\"\"]}{service.cached::isfalse[\" | 👥 {stream.seeders}\"||\"\"]}{addon.name::exists[\" | 🛰️ {addon.name}\"||\"\"]}"
                }
            },
            "preferredQualities": ["BluRay REMUX", "BluRay", "WEB-DL", "WEBRip", "HDRip", "HC HD-Rip", "DVDRip", "HDTV", "CAM", "TS", "TC", "SCR", "Unknown"],
            "preferredResolutions": ["2160p", "1440p", "1080p", "720p"],
            "excludedQualities": ["CAM", "SCR", "TS", "TC"],
            "excludedVisualTags": ["3D"],
            "sortCriteria": {
                "global": [
                    { "key": "cached", "direction": "desc" }, { "key": "resolution", "direction": "desc" }, { "key": "quality", "direction": "desc" }, { "key": "visualTag", "direction": "desc" },
                    { "key": "audioTag", "direction": "desc" }, { "key": "size", "direction": "asc" }, { "key": "library", "direction": "desc" }
                ],
                "cached": [
                    { "key": "cached", "direction": "desc" }, { "key": "resolution", "direction": "desc" }, { "key": "quality", "direction": "desc" }, { "key": "addon", "direction": "desc" },
                    { "key": "size", "direction": "asc" }, { "key": "streamType", "direction": "desc" }
                ],
                "uncached": [
                    { "key": "streamType", "direction": "desc" }, { "key": "resolution", "direction": "desc" }, { "key": "quality", "direction": "desc" }, { "key": "size", "direction": "asc" }, { "key": "seeders", "direction": "desc" }
                ]
            },
            "posterService": "rpdb",
            "deduplicator": { "enabled": true, "excludeAddons": [], "multiGroupBehaviour": "aggressive", "keys": ["filename", "infoHash"], "cached": "per_addon", "uncached": "per_service", "p2p": "single_result" },
            "trusted": false,
            "excludedResolutions": ["144p", "240p", "360p", "480p", "576p"],
            "includedResolutions": [],
            "requiredResolutions": [],
            "includedQualities": [],
            "requiredQualities": [],
            "excludedLanguages": [],
            "includedLanguages": [],
            "requiredLanguages": [],
            "preferredLanguages": ["English"],
            "includedVisualTags": [],
            "requiredVisualTags": [],
            "preferredVisualTags": ["HDR+DV", "DV Only", "HDR Only", "HDR10+", "HDR10", "DV", "HDR"],
            "excludedAudioTags": [],
            "includedAudioTags": [],
            "requiredAudioTags": [],
            "preferredAudioTags": ["Atmos", "DD+", "DD", "DTS-HD MA", "DTS-HD", "DTS-ES", "DTS", "TrueHD", "OPUS", "FLAC", "AAC"],
            "excludedAudioChannels": [],
            "includedAudioChannels": [],
            "requiredAudioChannels": [],
            "preferredAudioChannels": [],
            "excludedStreamTypes": [],
            "includedStreamTypes": [],
            "requiredStreamTypes": [],
            "preferredStreamTypes": ["usenet"],
            "excludedEncodes": [],
            "includedEncodes": [],
            "requiredEncodes": [],
            "preferredEncodes": [],
            "excludedKeywords": [],
            "includeSeederRange": [0, 1000],
            "requiredSeederRange": [10, 1000],
            "seederRangeTypes": ["p2p"],
            "ageRangeTypes": ["usenet"],
            "digitalReleaseFilter": { "enabled": false, "tolerance": 1, "requestTypes": ["movie", "series", "anime"], "addons": [] },
            "excludeCachedFromAddons": [],
            "excludeCachedFromServices": [],
            "excludeCachedFromStreamTypes": [],
            "excludeUncached": false,
            "excludeUncachedFromAddons": [],
            "excludeUncachedFromServices": [],
            "excludeUncachedFromStreamTypes": [],
            "dynamicAddonFetching": { "enabled": false, "condition": "count(cached(totalStreams)) >= 5 or totalTimeTaken >= 3000." },
            "groups": {
                "enabled": true,
                "groupings": [
                    { "addons": ["1c5", "bcd", "be5"], "condition": "true" },
                    { "addons": ["23a", "b9f", "da0"], "condition": "(count(resolution(cached(totalStreams)) >= 3 and count(resolution(cached(totalStreams), '1080p')) >= 3 and count(resolution(cached(totalStreams), '720p')) >= 3) or totalTimeTaken > 10000" },
                    { "addons": ["92e", "705", "9a3", "f89"], "condition": "(count(resolution(cached(totalStreams)) >= 3 and count(resolution(cached(totalStreams)) >= 3 and count(resolution(cached(totalStreams), '1080p')) >= 3 and count(resolution(cached(totalStreams), '720p')) >= 3) or totalTimeTaken > 10000" }
                ],
                "behaviour": "parallel"
            },
            "proxy": { "id": "builtin", "proxiedAddons": [], "proxiedServices": [] },
            "resultLimits": { "resolution": 3 },
            "size": { "global": { "movies": [0, 100000000000], "series": [0, 100000000000] } },
            "hideErrors": true,
            "hideErrorsForResources": [],
            "statistics": { "statsToShow": ["addon", "filter"] },
            "yearMatching": { "enabled": true, "requestTypes": [], "addons": [] },
            "titleMatching": { "mode": "contains", "enabled": true, "requestTypes": [], "addons": [] },
            "seasonEpisodeMatching": { "enabled": true, "requestTypes": [], "addons": [] },
            "autoPlay": { "attributes": ["quality", "resolution", "service"] },
            "areYouStillThere": { "enabled": true, "episodesBeforeCheck": 4 },
            "precacheNextEpisode": true,
            "alwaysPrecache": true,
            "catalogModifications": [
                { "id": "23a791b.torrentio-torbox-torrents", "name": "TorBox Torrents", "type": "other", "enabled": false, "shuffle": false, "usePosterService": false, "hideable": true, "searchable": false, "addonName": "Torrentio" },
                { "id": "23a791b.torrentio-torbox-usenet", "name": "TorBox Usenet", "type": "other", "enabled": false, "shuffle": false, "usePosterService": false, "hideable": true, "searchable": false, "addonName": "Torrentio" },
                { "id": "23a791b.torrentio-torbox-webdl", "name": "TorBox WebDL", "type": "other", "enabled": false, "shuffle": false, "usePosterService": false, "hideable": true, "searchable": false, "addonName": "Torrentio" }
            ],
            "cacheAndPlay": { "streamTypes": ["usenet"] },
            "autoRemoveDownloads": true
        };
        // --- EMBEDDED JSON DATA END ---

        // State
        let currentMode = '';
        let wizardFlow = [];
        let currentStepIdx = 0;
        let catalogState = []; // Holds the unified catalog objects
        const GB_BYTES = 1073741824;

        // Language Config
        const availableLanguages = [
            { label: "English", code: "English" },
            { label: "Spanish", code: "Spanish" },
            { label: "French", code: "French" },
            { label: "German", code: "German" },
            { label: "Italian", code: "Italian" },
            { label: "Portuguese", code: "Portuguese" },
            { label: "Russian", code: "Russian" },
            { label: "Hindi", code: "Hindi" },
            { label: "Japanese", code: "Japanese" },
            { label: "Korean", code: "Korean" },
            { label: "Chinese", code: "Chinese" },
            { label: "Arabic", code: "Arabic" }
        ];

        // --- INIT & UTILS ---

        function initLanguages() {
            const grid = document.getElementById('lang-grid');
            grid.innerHTML = '';
            availableLanguages.forEach(l => {
                const checked = l.code === 'English' ? 'checked' : '';
                grid.innerHTML += `
                    <label class="flex items-center space-x-2 bg-slate-800 p-3 rounded-lg border border-slate-700 hover:border-indigo-500/50 cursor-pointer">
                        <input type="checkbox" value="${l.code}" class="lang-check w-4 h-4 text-indigo-600 rounded bg-slate-700 border-slate-600 focus:ring-indigo-500" ${checked}>
                        <span class="text-sm font-medium text-slate-200">${l.label}</span>
                    </label>
                `;
            });
        }

        function initCatalogs() {
            const raw = MASTER_METADATA.config.catalogs;
            const grouped = {};

            raw.forEach(c => {
                // Clean Name first (removes (Movies)/(Series) so they match)
                let cleanName = c.name.replace(' (Movies)', '').replace(' (Series)', '');
                
                // FIX: Group by Name instead of ID.
                // This merges separate Movie/Series catalogs into one single checkbox row
                let key = cleanName; 
                
                if (!grouped[key]) {
                    grouped[key] = {
                        id: key,
                        displayName: cleanName,
                        type: c.type === 'anime' ? 'anime' : 'standard',
                        items: [], 
                        enabled: c.enabled, // Discovery Toggle
                        showInHome: c.showInHome // Home Toggle
                    };
                }
                grouped[key].items.push(c);
            });

            catalogState = Object.values(grouped);
            renderCatalogs();
        }

        function toggleAllCatalogs(type, isChecked) {
            const showAnime = document.getElementById('include-anime').checked;
            
            catalogState.forEach((cat, idx) => {
                // Respect anime filter
                if (cat.type === 'anime' && !showAnime) return;

                if (type === 'home') updateCatalogState(idx, 'showInHome', isChecked);
                if (type === 'discovery') updateCatalogState(idx, 'enabled', isChecked);
            });
            renderCatalogs();
        }

        function renderCatalogs() {
            const container = document.getElementById('catalog-container');
            container.innerHTML = '';
            const showAnime = document.getElementById('include-anime').checked;

            catalogState.forEach((cat, idx) => {
                if (cat.type === 'anime' && !showAnime) return;

                const div = document.createElement('div');
                div.className = "bg-slate-800 p-3 rounded flex items-center justify-between group hover:bg-slate-700/80 transition-colors";
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <div class="flex flex-col gap-1">
                            <button type="button" onclick="moveCatalog(${idx}, -1)" class="text-slate-500 hover:text-indigo-400 text-[10px] leading-none">▲</button>
                            <button type="button" onclick="moveCatalog(${idx}, 1)" class="text-slate-500 hover:text-indigo-400 text-[10px] leading-none">▼</button>
                        </div>
                        <span class="font-bold text-sm text-slate-200">${cat.displayName}</span>
                        ${cat.type === 'anime' ? '<span class="text-[10px] bg-purple-900/50 text-purple-300 px-1 rounded">ANIME</span>' : ''}
                    </div>
                    <div class="flex gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" ${cat.showInHome ? 'checked' : ''} onchange="updateCatalog(${idx}, 'showInHome', this.checked)" class="rounded bg-slate-700 border-slate-600 text-indigo-500 w-4 h-4">
                            <span class="text-xs text-slate-400">Home</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" ${cat.enabled ? 'checked' : ''} onchange="updateCatalog(${idx}, 'enabled', this.checked)" class="rounded bg-slate-700 border-slate-600 text-indigo-500 w-4 h-4">
                            <span class="text-xs text-slate-400">Discovery</span>
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function moveCatalog(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= catalogState.length) return;
            // Swap
            [catalogState[index], catalogState[newIndex]] = [catalogState[newIndex], catalogState[index]];
            renderCatalogs();
        }

        // Logic enforcement separated from rendering for "Select All" efficiency
        function updateCatalogState(index, field, value) {
            const cat = catalogState[index];
            cat[field] = value;

            // Logic enforcement:
            // 1. If Home is enabled, Discovery MUST be enabled (cannot have on Home if disabled globally)
            if (field === 'showInHome' && value === true) {
                cat.enabled = true;
            }
            // 2. If Discovery is disabled, Home MUST be disabled.
            if (field === 'enabled' && value === false) {
                cat.showInHome = false;
            }
        }

        // Wrapper for single item change (state update + render)
        function updateCatalog(index, field, value) {
            updateCatalogState(index, field, value);
            renderCatalogs();
        }

        function moveStreamingToTop() {
            // Filter and sort
            const streaming = [];
            const others = [];
            
            catalogState.forEach(cat => {
                if (cat.id.startsWith('streaming.')) {
                    streaming.push(cat);
                } else {
                    others.push(cat);
                }
            });
            
            catalogState = [...streaming, ...others];
            renderCatalogs();
        }

        // --- PAGE LOGIC ---

        function toggleDebridInput(id, checked) {
            document.getElementById(id).classList.toggle('hidden', !checked);
        }
        function toggleGemini(checked) {
            document.getElementById('gemini-input').classList.toggle('hidden', !checked);
        }
        function toggleDebridio(checked) {
            document.getElementById('debridio-input').classList.toggle('hidden', !checked);
        }
        // Redundant function definition to keep the original search line working below if needed
        function _ignored_toggleGemini(checked) {
            document.getElementById('gemini-input').classList.toggle('hidden', !checked);
        }

        document.getElementById('do-limit').addEventListener('change', e => document.getElementById('speed-options').classList.toggle('hidden', !e.target.checked));
        document.getElementById('do-posters').addEventListener('change', e => document.getElementById('poster-options').classList.toggle('hidden', !e.target.checked));

        function startSetup(m) {
            currentMode = m;
            document.getElementById('page-hub').classList.remove('active');
            document.getElementById('page-wizard').classList.add('active');
            
            if (m === 'streams') wizardFlow = ['step-debrid', 'step-speed', 'step-prefs', 'step-keys'];
            else if (m === 'meta') wizardFlow = ['step-prefs', 'step-catalogs', 'step-keys', 'step-posters'];
            else wizardFlow = ['step-debrid', 'step-speed', 'step-prefs', 'step-catalogs', 'step-keys', 'step-posters'];

            // Init dynamic UI
            initLanguages();
            if (m !== 'streams') initCatalogs();

            renderStep(0);
        }

        function renderStep(idx) {
            wizardFlow.forEach(id => document.getElementById(id).classList.remove('active'));
            document.getElementById(wizardFlow[idx]).classList.add('active');
            currentStepIdx = idx;
            
            const isStreams = currentMode === 'streams';
            const isMeta = currentMode === 'meta';

            // UI Conditional Visibility
            document.getElementById('streams-token-field').style.display = isMeta ? 'none' : 'block';
            document.getElementById('section-languages').style.display = isMeta ? 'none' : 'block'; 
            document.getElementById('section-interface-lang').style.display = isStreams ? 'none' : 'block'; 
            document.getElementById('section-autoplay').style.display = isMeta ? 'none' : 'block'; 
            document.getElementById('prefs-res-limit').style.display = isMeta ? 'none' : 'block';
            document.getElementById('cam-box').style.display = isMeta ? 'none' : 'flex';
            
            // HIDE Debridio in Meta Mode
            const debSection = document.getElementById('debridio-section');
            if(debSection) debSection.style.display = isMeta ? 'none' : 'block';
            
            document.getElementById('next-btn').style.display = (idx === wizardFlow.length - 1) ? 'none' : 'block';
            document.getElementById('finish-btn').classList.toggle('hidden', idx !== wizardFlow.length - 1);
        }

        function goNext() { if (currentStepIdx < wizardFlow.length - 1) renderStep(currentStepIdx + 1); }
        function goBack() {
            if (currentStepIdx === 0) {
                document.getElementById('page-wizard').classList.remove('active');
                document.getElementById('page-hub').classList.add('active');
            } else renderStep(currentStepIdx - 1);
        }
        
        function goBackToWizard() {
            document.getElementById('page-downloads').classList.remove('active');
            document.getElementById('page-wizard').classList.add('active');
        }

        // --- VALIDATION & BUILD ---

        function validateStep() {
            const currentStepId = wizardFlow[currentStepIdx];
            
            if (currentStepId === 'step-debrid') {
                const checks = document.querySelectorAll('.debrid-check');
                for (let c of checks) {
                    if (c.checked) {
                        let actualInputId = '';
                        if(c.id === 'use-rd') actualInputId = 'key-realdebrid';
                        else if(c.id === 'use-tb') actualInputId = 'key-torbox';
                        else if(c.id === 'use-ad') actualInputId = 'key-alldebrid';
                        else if(c.id === 'use-pm') actualInputId = 'key-premiumize';
                        else if(c.id === 'use-dl') actualInputId = 'key-debridlink';
                        
                        if (actualInputId && !document.getElementById(actualInputId).value.trim()) {
                            alert(`Please enter an API key for ${c.nextElementSibling.innerText}`);
                            return false;
                        }
                    }
                }
            }

            if (currentStepId === 'step-keys') {
                // Debridio Validation (Only if visible/not meta)
                if (currentMode !== 'meta' && document.getElementById('enable-debridio').checked) {
                    if (!document.getElementById('debridio-key').value.trim()) {
                        alert("Please enter a Debridio API Key or uncheck the box.");
                        return false;
                    }
                }

                const tmdb = document.getElementById('tmdb-key').value.trim();
                if (!tmdb) { alert("TMDb API Key is required."); return false; }
                
                if (currentMode !== 'streams') {
                    if (!document.getElementById('tvdb-key').value.trim()) { alert("TVDB API Key is required for Metadata."); return false; }
                    if (!document.getElementById('fanart-key').value.trim()) { alert("Fanart API Key is required for Metadata."); return false; }
                }

                if (document.getElementById('enable-gemini').checked) {
                    if (!document.getElementById('gemini-key').value.trim()) {
                        alert("Please enter a Gemini API Key or uncheck the box.");
                        return false;
                    }
                }
            }
            return true;
        }

        function validateAndGoNext() { if (validateStep()) goNext(); }
        function validateAndFinalize() { if (validateStep()) finalizeBuild(); }

        function finalizeBuild() {
            // 1. Clear container BEFORE starting
            const con = document.getElementById('dl-container');
            con.innerHTML = 'Generating...';

            document.getElementById('page-wizard').classList.remove('active');
            document.getElementById('page-downloads').classList.add('active');

            // Inputs
            const t3 = document.getElementById('tmdb-key').value;
            const t4 = document.getElementById('tmdb-token').value;
            const tv = document.getElementById('tvdb-key').value;
            const fa = document.getElementById('fanart-key').value;
            const geminiKey = document.getElementById('gemini-key').value;
            const resLimit = document.getElementById('res-limit').value || 5;
            const interfaceLang = document.getElementById('interface-lang').value;
            const autoPlayMethod = document.getElementById('autoplay-method').value;

            // Clear loading text now that we are ready to append buttons
            con.innerHTML = '';

            // --- BUILD METADATA ---
            let metaGenerated = false;
            if (currentMode !== 'streams') {
                try {
                    const mBase = JSON.parse(JSON.stringify(MASTER_METADATA));
                    
                    // Assign keys
                    mBase.config.apiKeys.tmdb = t3;
                    mBase.config.apiKeys.tvdb = tv;
                    mBase.config.apiKeys.fanart = fa;
                    
                    if(mBase.metadata) mBase.metadata.apiKeysExcluded = false;
                    mBase.config.language = interfaceLang;

                    // Gemini Logic
                    if (document.getElementById('enable-gemini').checked) {
                        mBase.config.apiKeys.gemini = geminiKey;
                        if (mBase.config.search) {
                            mBase.config.search.ai_enabled = true;
                            if(mBase.config.search.engineEnabled) mBase.config.search.engineEnabled["gemini.search"] = true;
                            if(mBase.config.search.engineRatingPosters) mBase.config.search.engineRatingPosters["gemini.search"] = true;
                        }
                    } else {
                        mBase.config.apiKeys.gemini = "";
                        if (mBase.config.search) {
                            mBase.config.search.ai_enabled = false;
                            if(mBase.config.search.engineEnabled) mBase.config.search.engineEnabled["gemini.search"] = false;
                            if(mBase.config.search.engineRatingPosters) mBase.config.search.engineRatingPosters["gemini.search"] = false;
                        }
                    }
                    
                    // RPDB Logic
                    if (document.getElementById('do-posters').checked) {
                        const prov = document.getElementById('poster-provider').value;
                        const pKey = document.getElementById('poster-key').value;
                        mBase.config.posterRatingProvider = prov;
                        
                        if (prov === 'rpdb') {
                            mBase.config.apiKeys.rpdb = pKey;
                            mBase.config.apiKeys.topPoster = ""; 
                        } else {
                            mBase.config.apiKeys.topPoster = pKey;
                            mBase.config.apiKeys.rpdb = "";
                        }
                    }

                    // Reconstruct Catalogs
                    let finalCatalogs = [];
                    const includeAnime = document.getElementById('include-anime').checked;
                    
                    catalogState.forEach(group => {
                        if (group.type === 'anime' && !includeAnime) return;
                        group.items.forEach(item => {
                            item.showInHome = group.showInHome;
                            item.enabled = group.enabled; 
                            finalCatalogs.push(item);
                        });
                    });
                    
                    mBase.config.catalogs = finalCatalogs;
                    spawnDownloadBtn('💾 Download AIOMetadata JSON', mBase, 'aiometadata-config.json');
                    
                    // Show Instructions
                    document.getElementById('instr-meta').classList.remove('hidden');
                    metaGenerated = true;
                } catch(e) { console.error("Meta Build Error", e); }
            }

            // --- BUILD STREAMS ---
            if (currentMode !== 'meta') {
                try {
                    const hasDebrid = document.querySelectorAll('.debrid-check:checked').length > 0;
                    const base = hasDebrid ? JSON.parse(JSON.stringify(MASTER_WITH_DEBRID)) : JSON.parse(JSON.stringify(MASTER_WITHOUT_DEBRID));
                    
                    base.addonName = "TVFlix";
                    base.addonLogo = "https://tvflix.co.uk/wp-content/uploads/2025/04/Untitled-design_20250422_200739_0000.webp";

                    base.tmdbApiKey = t3;
                    base.tmdbAccessToken = t4;
                    base.tvdbApiKey = tv; 
                    base.resultLimits = { resolution: parseInt(resLimit) };

                    // Debridio (Only added for Streams)
                    if (document.getElementById('enable-debridio') && document.getElementById('enable-debridio').checked) {
                        const debKey = document.getElementById('debridio-key').value.trim();
                        if (base.presets) {
                            base.presets.push({
                                "type": "debridio",
                                "instanceId": "1d0",
                                "enabled": true,
                                "options": {
                                    "name": "Debridio Scraper",
                                    "timeout": 10000,
                                    "resources": ["stream"],
                                    "debridioApiKey": debKey,
                                    "mediaTypes": []
                                }
                            });
                        }
                    }                    
                    
                    if(base.autoPlay) base.autoPlay.method = autoPlayMethod;

                    // Size Limits
                    if (document.getElementById('do-limit').checked) {
                        const speedVal = document.getElementById('speed-val').value;
                        let maxBytes = 100000000000;
                        const GB = 1073741824;
                        if (speedVal === 'low') maxBytes = 10 * GB;
                        else if (speedVal === 'mid') maxBytes = 25 * GB;
                        else if (speedVal === 'high') maxBytes = 50 * GB;
                        
                        if (base.size && base.size.global) {
                            base.size.global.movies[1] = maxBytes;
                            base.size.global.series[1] = maxBytes;
                        }
                    }

                    // Sort Preference
                    const sortPref = document.getElementById('sort-pref').value;
                    const sizeSortDir = sortPref === 'speed' ? 'asc' : 'desc';
                    if (base.sortCriteria && base.sortCriteria.global) {
                        const sizeObj = base.sortCriteria.global.find(x => x.key === 'size');
                        if (sizeObj) sizeObj.direction = sizeSortDir;
                    }

                    // Audio Languages
                    const selectedLangs = Array.from(document.querySelectorAll('.lang-check:checked')).map(c => c.value);
                    if (selectedLangs.length > 0) {
                        if (selectedLangs.length === 1 && selectedLangs[0] === 'English') {
                            base.requiredLanguages = []; 
                            if (!base.preferredLanguages) base.preferredLanguages = [];
                            if (!base.preferredLanguages.includes('English')) base.preferredLanguages.unshift('English');
                        } else {
                            base.requiredLanguages = selectedLangs;
                            base.sortCriteria.global.unshift({ "key": "language", "direction": "desc" });
                            if (base.preferredLanguages) base.preferredLanguages = base.preferredLanguages.filter(l => l !== 'English');
                        }
                    }

                    // Group Logic
                    if (document.getElementById('enable-debridio') && document.getElementById('enable-debridio').checked && base.groups && Array.isArray(base.groups.groupings)) {
                         base.groups.groupings.unshift({ "addons": ["1d0"], "condition": "true" });
                    }
                    if (hasDebrid) {
                        const limitVal = parseInt(resLimit);
                        const groupCondition = `(count(resolution(cached(totalStreams), '2160p')) < ${limitVal} or count(resolution(cached(totalStreams), '1080p')) < ${limitVal} or count(resolution(cached(totalStreams), '720p')) < ${limitVal}) and totalTimeTaken < 20000`;
                        if (base.groups && Array.isArray(base.groups.groupings)) {
                            base.groups.groupings.forEach((group, index) => {
                                if (index > 0) group.condition = groupCondition;
                            });
                        }
                    } else {
                        if (base.groups) {
                            base.groups.enabled = false;
                            base.groups.groupings = [];
                        }
                    }

                    // CAMs
                    if (document.getElementById('include-cams').checked) {
                        base.excludedQualities = [];
                    }

                    // Debrid Mapping
                    const debridMap = { 'use-rd': 'realdebrid', 'use-tb': 'torbox', 'use-ad': 'alldebrid', 'use-pm': 'premiumize', 'use-dl': 'debridlink' };
                    for (const [chk, id] of Object.entries(debridMap)) {
                        const svc = base.services.find(s => s.id === id);
                        if (svc && document.getElementById(chk)) {
                            svc.enabled = document.getElementById(chk).checked;
                            const keyInput = document.getElementById(chk.replace('use', 'key').replace('rd','realdebrid').replace('tb','torbox').replace('ad','alldebrid').replace('pm','premiumize').replace('dl','debridlink'));
                            if (svc.enabled && keyInput) svc.credentials.apiKey = keyInput.value;
                        }
                    }

                    spawnDownloadBtn('💾 Download AIOStreams JSON', base, 'aiostreams-config.json');
                    
                    // Show Instructions
                    document.getElementById('instr-streams').classList.remove('hidden');
                } catch(e) { console.error("Streams Build Error", e); }
            }
            
            // Show Container
            document.getElementById('instructions-area').classList.remove('hidden');
            
            // --- DYNAMIC INSTRUCTIONS TEXT ---
            const stepsContainer = document.getElementById('instr-final');
            let stepsHTML = '';

            // HEADER (Common)
            stepsHTML += `
                <h3 class="text-xl font-bold text-white mb-4">3. Final Polish with CineBye</h3>
                <div class="mb-4">
                    <div class="mb-2 text-sm text-slate-300"><strong>Open CineBye Manager</strong></div>
                    <p class="text-xs text-slate-400 mb-2">This tool allows you to clean up your Stremio interface.</p>
                    <a href="https://cinebye.elfhosted.com/" target="_blank" class="inline-block bg-slate-700 px-4 py-2 rounded-lg text-white text-xs font-bold hover:bg-slate-600 border border-slate-500 transition-all">Open CineBye</a>
                </div>
                <ol class="list-decimal pl-5 space-y-4 text-slate-300 text-sm">
                    <li>Log in.</li>
            `;

            if (currentMode === 'streams') {
                // AIO STREAMS ONLY
                stepsHTML += `
                    <li><strong>Cleanup & Reorder:</strong> You can also reorder your addons here. To delete old addons, simply click the <strong>Red X</strong> next to them.</li>
                    <li>
                        <strong>Recommended Order:</strong>
                        <div class="pl-4 pt-2 font-mono text-xs text-indigo-300 leading-relaxed">
                            1. Cinemeta<br>
                            2. AIO Streams
                        </div>
                    </li>
                    <li>Click <strong>Sync to Stremio</strong>.</li>
                `;
            } else if (currentMode === 'meta') {
                // AIOMETA ONLY
                stepsHTML += `
                    <li>Tick <strong>Remove Cinemeta Catalogs</strong> and <strong>Remove Cinemeta Search</strong>.</li>
                    <li><strong>Cleanup & Reorder:</strong> You can also reorder your addons here. To delete old addons, simply click the <strong>Red X</strong> next to them.</li>
                    <li>
                        <strong>Recommended Order:</strong>
                        <div class="pl-4 pt-2 font-mono text-xs text-indigo-300 leading-relaxed">
                            1. Cinemeta (Required Base)<br>
                            2. AIO Metadata<br>
                            3. Your streaming addons
                        </div>
                    </li>
                    <li>Click <strong>Sync to Stremio</strong>.</li>
                `;
            } else {
                // FULL SETUP (Default)
                stepsHTML += `
                    <li>Tick <strong>Remove Cinemeta Catalogs</strong> and <strong>Remove Cinemeta Search</strong>.</li>
                    <li><strong>Cleanup & Reorder:</strong> You can also reorder your addons here. To delete old addons, simply click the <strong>Red X</strong> next to them.</li>
                    <li>
                        <strong>Recommended Order:</strong>
                        <div class="pl-4 pt-2 font-mono text-xs text-indigo-300 leading-relaxed">
                            1. Cinemeta (Required Base)<br>
                            2. AIO Metadata<br>
                            3. AIO Streams
                        </div>
                    </li>
                    <li>Click <strong>Sync to Stremio</strong>.</li>
                `;
            }

            stepsHTML += `</ol>`;

            // Footer (Common - Install Help)
            stepsHTML += `
                <div class="mt-8 pt-6 border-t border-slate-700">
                    <details class="group">
                        <summary class="flex items-center cursor-pointer text-xs font-bold text-amber-500 uppercase tracking-widest hover:text-amber-400">
                            <span class="mr-2">⚠️ Can't install to Stremio on this device?</span>
                            <span class="group-open:rotate-180 transition-transform">▼</span>
                        </summary>
                        <div class="mt-4 bg-slate-900 p-4 rounded-lg border border-slate-700 text-xs text-slate-400 leading-relaxed">
                            <p class="mb-2">If the "Install" buttons above don't open Stremio app:</p>
                            <ol class="list-decimal pl-4 space-y-2">
                                <li>Complete the Save step on the config websites to generate your <strong>Install URL</strong>.</li>
                                <li>Copy that long URL (it starts with <code>https://...</code>).</li>
                                <li>Open <a href="https://stremio-addon-manager.pages.dev/" target="_blank" class="text-indigo-400 underline">Addon Manager</a>.</li>
                                <li>Click <strong>Add Addon</strong> and paste the URL manually.</li>
                                <li>Click <strong>Sync to Stremio</strong>.</li>
                                <li>Go back and do the CineBye step afterwards.</li>
                            </ol>
                        </div>
                    </details>
                </div>
            `;
            
            // Inject the correct text
            stepsContainer.innerHTML = stepsHTML;
        }

        function spawnDownloadBtn(label, obj, filename) {
            const b = document.createElement('button');
            b.className = 'bg-slate-700 p-5 rounded-xl font-bold border-2 border-indigo-600 hover:bg-indigo-600 transition-all text-white w-full shadow-lg';
            b.innerText = label;
            b.onclick = () => {
                const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
            };
            document.getElementById('dl-container').appendChild(b);
        }
    </script>
</body>
</html>
